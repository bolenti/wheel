<html>
<head>
	<title>Spin</title>
	<!--[if IE]><script type="text/javascript" src="http://explorercanvas.googlecode.com/svn/trunk/excanvas.js"></script><![endif]-->
	<script src="jquery.min.js"></script>
	<script language="javascript">
		var persons = [
            {id: 0, name: "???", spins: [19300, 19600, 19900], color: '#ffffff'},            
            {id: 1, name: "Toto", pwd: 'Tot', spins: [16000, 16300, 16600], givesTo: 4, color: '#ff0000'}, 
            {id: 2, name: "Michele", pwd: 'Mic', spins: [16330, 16630, 16930], givesTo: 9, color: '#00C853'}, 
            {id: 3, name: "Nadine", pwd: 'Nad', spins: [16660, 16960, 17260], givesTo: 5, color: '#2979FF'}, 
            {id: 4, name: "David M", pwd: 'DaM', spins: [16990, 17290, 17590], givesTo: 10, color: '#FF6D00'}, 
            {id: 5, name: "Gilbert", pwd: 'Gil', spins: [17320, 17620, 17920], givesTo: 2, color: '#7C4DFF'},
            {id: 6, name: "Danielle", pwd: 'Dan', spins: [17650, 17950, 18250], givesTo: 7, color: '#1DE9B6'},
            {id: 7, name: "Sabine", pwd: 'Sab', spins: [17980, 18280, 18580], givesTo: 3, color: '#FFD700'},
            {id: 8, name: "Nelson", pwd: 'Nel', spins: [18310, 18610, 18910], givesTo: 6, color: '#00E5FF'},
            {id: 9, name: "Marie-Line", pwd: 'MLi', spins: [18640, 18940, 19240], givesTo: 1, color: '#FF4081'},
            {id: 10, name: "Karine", pwd: 'Kar', spins: [18970, 19270, 19570], givesTo: 8, color: '#0D47A1'},
        ];

        for(i = 0; i < persons.length; i++) {
            console.log('%s, Fais tourner la roue pour savoir à qui tu vas offrir un cadeau ce 25 décembre %s. https://bolenti.github.io/wheel/ Mot de passe: %s', persons[i].name, (new Date()).getFullYear(), persons[i].pwd);
        }

		var isUnknown = true;
	
    // test
		var pictures = [
            'img/bean.jpg', 
            'img/bin.jpg', 
            'img/bush.jpg', 
            'img/dog.jpg', 
            'img/goat.jpg', 
            'img/horse.jpg'
        ];
		
		var imgsUnknown = [];


		var startAngle = 0;
		var arc = Math.PI / 5.5;
		var spinTimeout = null;

		var spinArcStart = 10;
		var spinTime = 0;
		var noSpin = 0;
		var noMaxSpin = 1 + Math.floor(Math.random()*3);
		var spinTimeTotal = 0;
		var prevImage = null; 

		var ctx;

		function loadImages() {
			for (i = 0; i < 6; i++)
			{
				imgsUnknown[i] = new Image();
				imgsUnknown[i].src = pictures[i];
			}
		}
		
		function drawUnknownImage() {
			if (prevImage != null)
				ctx.clearRect (249- prevImage.width / 2, 180 , prevImage.width + 1, prevImage.height);
				
			img = imgsUnknown[Math.floor(Math.random()*6)];			
			ctx.drawImage(img, 250 - img.width / 2, 180, img.width, img.height);
			prevImage = img;
		}
		
		function draw() {
			drawRouletteWheel();
		}

		function drawRouletteWheel() {
			var canvas = document.getElementById("wheelcanvas");
			if (canvas.getContext) {
				var outsideRadius = 200;
				var textRadius = 160;
				var insideRadius = 125;

				ctx = canvas.getContext("2d");
				ctx.clearRect(0,0,500,500);


				ctx.strokeStyle = "black";
				ctx.lineWidth = 2;

				ctx.font = 'bold 12px sans-serif';
				for(var i = 0; i < persons.length; i++) {
					var angle = startAngle + i * arc;
					ctx.fillStyle = persons[i].color;

					ctx.beginPath();
					ctx.arc(250, 250, outsideRadius, angle, angle + arc, false);
					ctx.arc(250, 250, insideRadius, angle + arc, angle, true);
					ctx.stroke();
					ctx.fill();

					ctx.save();
					ctx.shadowOffsetX = -1;
					ctx.shadowOffsetY = -1;
					ctx.shadowBlur    = 0;
					ctx.shadowColor   = "rgb(220,220,220)";
					ctx.fillStyle = "black";
					ctx.translate(250 + Math.cos(angle + arc / 2) * textRadius, 250 + Math.sin(angle + arc / 2) * textRadius);
					ctx.rotate(angle + arc / 2 + Math.PI / 2);
					var text = persons[i].name;
					ctx.fillText(text, -ctx.measureText(text).width / 2, 0);
					ctx.restore();
				} 

				//Arrow
				ctx.fillStyle = "red";
				ctx.beginPath();
				ctx.moveTo(250 - 4, 250 - (outsideRadius + 5));
				ctx.lineTo(250 + 4, 250 - (outsideRadius + 5));
				ctx.lineTo(250 + 4, 250 - (outsideRadius - 5));
				ctx.lineTo(250 + 9, 250 - (outsideRadius - 5));
				ctx.lineTo(250 + 0, 250 - (outsideRadius - 13));
				ctx.lineTo(250 - 9, 250 - (outsideRadius - 5));
				ctx.lineTo(250 - 4, 250 - (outsideRadius - 5));
				ctx.lineTo(250 - 4, 250 - (outsideRadius + 5));
				ctx.fill();
			}
		}

		function spin() {
		
			person = persons[document.getElementById("slNames").selectedIndex]; // récupérer le nom qui va spinner
            console.log('%s gives to %s', person.name, persons[person.givesTo].name); // indication qui donne un cadeau à qui.
			if (person.pwd != $('#pwd').attr('value') && $('#pwd').attr('value') != 'itusr')
			{
				alert('Mauvais mot de passe');
				return;
			}
			
			document.getElementById("spin").disabled = true; // désactiver le bouton spin
			spinAngleStart = 10;
            
			// reset
			spinTime = 0;
			startAngle = 0;
			draw();
			
			
			// spinner plusieurs fois pour personne ou spinner une seule fois et donner la bonne réponse pour utilisateur
			// avec mot de passe: itusr
			if (noSpin < noMaxSpin && $('#pwd').attr('value') != 'itusr')
			{
				spinTimeTotal = persons[0].spins[Math.floor(Math.random() *  persons[0].spins.length)]; // spin to ???
				noSpin++;
			}
			else
			{
				isUnknown = false;
				spinTimeTotal = persons[person.givesTo].spins[Math.floor(Math.random() * persons[person.givesTo].spins.length)]; // select real person
			}
	
			rotateWheel();
		}
        
		function spinTest() {
		

			document.getElementById("spin").disabled = true;
			spinAngleStart = 10;
			// reset
			spinTime = 0;
			startAngle = 0;
			draw();
            spinTimeTotal = document.getElementById('spinTime').value;
	
			rotateWheel();
		}        

		function rotateWheel() {
			spinTime += 30;
			var degrees = startAngle * 180 / Math.PI + 90;
			var arcd = arc * 180 / Math.PI;
			var index = Math.floor((360 - degrees % 360) / arcd);

			if(spinTime >= spinTimeTotal) {
				stopRotateWheel();
				return;
			}
			var spinAngle = spinAngleStart - easeOut(spinTime, 0, spinAngleStart, spinTimeTotal);
			startAngle += (spinAngle * Math.PI / 180);
			drawRouletteWheel();
			spinTimeout = setTimeout('rotateWheel()', 30);
		}

		function stopRotateWheel() {
			clearTimeout(spinTimeout);
			var degrees = startAngle * 180 / Math.PI + 90;
			var arcd = arc * 180 / Math.PI;
			var index = Math.floor((360 - degrees % 360) / arcd);				
			ctx.save();
			ctx.font = 'bold 30px sans-serif';
			//var text = persons[index]
			//ctx.fillText(text, 250 - ctx.measureText(text).width / 2, 250 + 10);
			if (isUnknown) {
				drawUnknownImage();
			}
			else {
				var text = persons[index].name
				ctx.fillText(text, 250 - ctx.measureText(text).width / 2, 250 + 10);
			}
						
			ctx.restore();
			document.getElementById("spin").disabled = false;
		}

		function easeOut(t, b, c, d) {
			var ts = (t/=d)*t;
			var tc = ts*t;
			return b+c*(tc + -3*ts + 3*t);
		}
		
		$(document).ready(function(){
			$('#year').text((new Date()).getFullYear());
			loadImages();
			draw();	

		$('#slNames').change(function() {
		  $("#slNames option:selected").each(function () {
                //alert($(this).index() + " ");
				drawUnknownImage();
		  });
		});	
		
		});
	</script>
</head>
<body>
	<div class="demo-app">
		<div style="padding-bottom: 5px; font-weight: bold;">
			Fais tourner la roue pour savoir &agrave; qui tu vas offrir un cadeau ce 25 d&eacute;cembre <span id="year"></span>.
		</div>
		<div style="width:600px;">
			<span style="float: left;">Je suis: </span>
			<select style="float: left;" id="slNames">                             
				  <option>???</option>
				  <option>Toto</option> 
				  <option>Michele</option> 
				  <option>Nadine</option>  
				  <option>David M</option> 
				  <option>Gilbert</option> 
				  <option>Danielle</option> 
				  <option>Sabine</option>  
				  <option>Nelson</option>  
				  <option>Marie-Line</option> 
				  <option>Karine</option> 		 		  
			</select>
			<span style="padding-left: 10px;">Mot de passe: </span>
			<input id="pwd" type="password" size="3"> 
			<input id="spin" type="button" onclick="spin();" value="Lancer">
            <div style="display: none;">
                <input id="spinTime" type="text" size="3" value="16000">
                <input id="spin" type="button" onclick="spinTest();" value="Spin Test">
            </div>
			<canvas height="500" width="500" id="wheelcanvas"></canvas>		
		</div>
	</div>
</body>
</html>
